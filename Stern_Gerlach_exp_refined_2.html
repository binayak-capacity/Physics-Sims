<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stern-Gerlach Experiment Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: #0a0e17; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            color: #e2e8f0;
        }
        
        .top-header {
            width: 100%;
            height: 60px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 20px;
        }
        
        .top-header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .top-header h1 span {
            margin-right: 10px;
        }
        
        .top-header p {
            font-size: 12px;
            color: #94a3b8;
            margin-left: 15px;
        }
        
        .main-container {
            display: flex;
            width: 100vw;
            height: calc(100vh - 60px);
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .right-panel {
            width: 320px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            gap: 20px;
        }
        
        .panel-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
        }
        
        .panel-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            text-align: center;
            min-height: 70px;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .stat-value {
            color: #f1f5f9;
            font-weight: 600;
            font-size: 18px;
            font-variant-numeric: tabular-nums;
            min-width: 40px;
            text-align: center;
        }
        
        .spin-up { color: #f472b6; }
        .spin-down { color: #60a5fa; }
        
        .control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .control:last-child {
            margin-bottom: 0;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control label {
            color: #94a3b8;
            font-size: 12px;
        }
        
        .control-value-display {
            color: #f1f5f9;
            font-weight: 600;
            font-size: 13px;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 3px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        button {
            width: 100%;
            padding: 12px 16px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        button:last-child {
            margin-bottom: 0;
        }
        
        button.active {
            background: #f59e0b;
        }
        
        button.active:hover {
            background: #d97706;
        }
        
        .info-text {
            color: #94a3b8;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.initial { background: #a3e635; }
        .legend-dot.up { background: #f472b6; }
        .legend-dot.down { background: #60a5fa; }
        .legend-dot.classical { background: #f59e0b; }
        
        .mode-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .mode-indicator.quantum {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .mode-indicator.classical {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body>
    <div class="top-header">
        <h1><span>‚öõÔ∏è</span> Stern-Gerlach Experiment</h1>
        <p>Quantum vs Classical Spin Measurement Simulation</p>
    </div>
    
    <div class="main-container">
        <div id="canvas-container">
            <canvas id="mainCanvas"></canvas>
        </div>
        
        <div class="right-panel">
            <div class="panel-section">
                <h3>üìä Statistics</h3>
                <div id="modeIndicator" class="mode-indicator quantum">‚öõÔ∏è Quantum Mode</div>
                <div class="stat-group">
                    <div class="stat">
                        <span class="stat-label">Total Atoms</span>
                        <span class="stat-value" id="totalAtoms">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Spin ‚Üë</span>
                        <span class="stat-value spin-up" id="spinUp">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Spin ‚Üì</span>
                        <span class="stat-value spin-down" id="spinDown">0</span>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                <h3>‚öôÔ∏è Controls</h3>
                <div class="control">
                    <div class="control-header">
                        <label for="fieldStrength">Magnetic Field Strength</label>
                        <span class="control-value-display"><span id="fieldValue">5</span> T</span>
                    </div>
                    <input type="range" class="slider" id="fieldStrength" min="1" max="10" value="5">
                </div>
                <div class="control">
                    <div class="control-header">
                        <label for="emissionRate">Emission Rate</label>
                        <span class="control-value-display"><span id="emissionValue">8</span> /s</span>
                    </div>
                    <input type="range" class="slider" id="emissionRate" min="1" max="20" value="8">
                </div>
                <button id="classicalToggle">üîÑ Switch to Classical Mode</button>
                <button id="reset">üîÑ Reset Experiment</button>
            </div>
            
            <div class="panel-section">
                <h3>üìñ About the Experiment</h3>
                <p class="info-text">
                    <strong>Quantum:</strong> Silver atoms deflect to only two discrete positions (¬±¬Ω‚Ñè), demonstrating quantized spin.
                    <br><br>
                    <strong>Classical:</strong> Classical physics predicted a continuous spread of deflections based on random magnetic moment orientations.
                </p>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot initial"></div>
                        <span>Initial beam (superposition)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot up"></div>
                        <span>Spin +¬Ω (deflected up)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot down"></div>
                        <span>Spin -¬Ω (deflected down)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot classical"></div>
                        <span>Classical (continuous)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let atoms = [];
        let spinUpCount = 0;
        let spinDownCount = 0;
        let totalCount = 0;
        let lastEmitTime = 0;
        
        // Controls
        let fieldStrength = 5;
        let emissionRate = 8;
        let classicalMode = false;  // NEW: Toggle for classical vs quantum behavior
        
        // Layout positions (will be calculated based on canvas size)
        let sourceX, magnetStartX, magnetEndX, detectorX, detectorWindowX;
        let magnetTopY, magnetBottomY, centerY;
        let detectorHeight, detectorWindowHeight, detectorWindowWidth;
        
        // Detector window data - store detection points
        let detectionPoints = [];
        
        // Colors
        const INITIAL_COLOR = '#a3e635';  // Lime green for initial beam
        const INITIAL_COLOR_RGBA = 'rgba(163, 230, 53, ';
        const SPIN_UP_COLOR = '#f472b6';  // Pink for spin up
        const SPIN_UP_COLOR_RGBA = 'rgba(244, 114, 182, ';
        const SPIN_DOWN_COLOR = '#60a5fa';  // Blue for spin down
        const SPIN_DOWN_COLOR_RGBA = 'rgba(96, 165, 250, ';
        const CLASSICAL_COLOR = '#f59e0b';  // Amber for classical
        const CLASSICAL_COLOR_RGBA = 'rgba(245, 158, 11, ';
        
        function resize() {
            const container = document.getElementById('canvas-container');
            width = canvas.width = container.clientWidth;
            height = canvas.height = container.clientHeight;
            
            // Calculate layout - adjusted to make room for detector window
            sourceX = width * 0.06;
            magnetStartX = width * 0.22;
            magnetEndX = width * 0.45;
            detectorX = width * 0.62;
            detectorWindowX = width * 0.72;
            centerY = height * 0.5;
            magnetTopY = centerY - height * 0.2;
            magnetBottomY = centerY + height * 0.2;
            
            detectorWindowHeight = height * 0.85;
            detectorWindowWidth = width * 0.18;
            detectorHeight = detectorWindowHeight;
        }
        
        class Atom {
            constructor() {
                this.x = sourceX;
                this.y = centerY + (Math.random() - 0.5) * 20;
                this.vx = 2 + Math.random() * 0.5;
                this.vy = 0;
                
                // NEW: In classical mode, spin is a continuous value from -1 to 1
                // In quantum mode, spin is discrete: +1 or -1
                if (classicalMode) {
                    this.spin = (Math.random() * 2 - 1);  // Continuous from -1 to 1
                    this.isClassical = true;
                } else {
                    this.spin = Math.random() < 0.5 ? 1 : -1;
                    this.isClassical = false;
                }
                
                this.inField = false;
                this.pastField = false;
                this.hasEnteredField = false;
                this.detected = false;
                this.trail = [];
                this.size = 4;
                this.alpha = 1;
            }
            
            getCurrentColor() {
                if (!this.hasEnteredField) {
                    return INITIAL_COLOR;
                } else if (this.isClassical) {
                    return CLASSICAL_COLOR;
                } else {
                    return this.spin > 0 ? SPIN_UP_COLOR : SPIN_DOWN_COLOR;
                }
            }
            
            getCurrentColorRGBA(alpha) {
                if (!this.hasEnteredField) {
                    return INITIAL_COLOR_RGBA + alpha + ')';
                } else if (this.isClassical) {
                    return CLASSICAL_COLOR_RGBA + alpha + ')';
                } else {
                    return this.spin > 0 ? SPIN_UP_COLOR_RGBA + alpha + ')' : SPIN_DOWN_COLOR_RGBA + alpha + ')';
                }
            }
            
            update() {
                if (this.detected) return false;
                
                if (this.trail.length > 30) this.trail.shift();
                this.trail.push({ 
                    x: this.x, 
                    y: this.y, 
                    hasEnteredField: this.hasEnteredField,
                    spin: this.spin,
                    isClassical: this.isClassical
                });
                
                if (this.x >= magnetStartX && this.x <= magnetEndX) {
                    this.inField = true;
                    this.hasEnteredField = true;
                    // Same physics, but classical atoms have continuous spin values
                    const fieldEffect = fieldStrength * 0.0015 * this.spin;
                    this.vy += fieldEffect;
                } else if (this.x > magnetEndX) {
                    this.pastField = true;
                }
                
                this.x += this.vx;
                this.y += this.vy;
                
                if (this.x >= detectorX) {
                    this.detected = true;
                    this.recordDetection();
                    return false;
                }
                
                if (this.y < 0 || this.y > height) {
                    return false;
                }
                
                return true;
            }
            
            recordDetection() {
                totalCount++;
                if (!this.isClassical) {
                    if (this.spin > 0) {
                        spinUpCount++;
                    } else {
                        spinDownCount++;
                    }
                }
                
                const windowTop = centerY - detectorWindowHeight / 2;
                const relativeY = this.y - windowTop;
                const normalizedY = Math.max(5, Math.min(detectorWindowHeight - 5, relativeY));
                
                detectionPoints.push({
                    y: normalizedY,
                    spin: this.spin,
                    isClassical: this.isClassical,
                    x: (Math.random() - 0.5) * (detectorWindowWidth * 0.6)
                });
                
                if (detectionPoints.length > 2000) {
                    detectionPoints.shift();
                }
            }
            
            draw() {
                if (this.trail.length > 1) {
                    for (let i = 1; i < this.trail.length; i++) {
                        const prev = this.trail[i - 1];
                        const curr = this.trail[i];
                        
                        ctx.beginPath();
                        ctx.moveTo(prev.x, prev.y);
                        ctx.lineTo(curr.x, curr.y);
                        
                        let trailColor;
                        if (!curr.hasEnteredField) {
                            trailColor = INITIAL_COLOR_RGBA + '0.3)';
                        } else if (curr.isClassical) {
                            trailColor = CLASSICAL_COLOR_RGBA + '0.3)';
                        } else {
                            trailColor = curr.spin > 0 ? SPIN_UP_COLOR_RGBA + '0.3)' : SPIN_DOWN_COLOR_RGBA + '0.3)';
                        }
                        
                        ctx.strokeStyle = trailColor;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
                
                const color = this.getCurrentColor();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 3);
                gradient.addColorStop(0, this.getCurrentColorRGBA(0.4));
                gradient.addColorStop(1, 'transparent');
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 3, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }
        
        function drawBackground() {
            ctx.fillStyle = '#0a0e17';
            ctx.fillRect(0, 0, width, height);
            
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.05)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            for (let x = 0; x < width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y < height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
        }
        
        function drawSource() {
            const gradient = ctx.createLinearGradient(sourceX - 40, 0, sourceX + 20, 0);
            gradient.addColorStop(0, '#374151');
            gradient.addColorStop(1, '#4b5563');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.roundRect(sourceX - 50, centerY - 40, 60, 80, 8);
            ctx.fill();
            
            const glowGradient = ctx.createRadialGradient(sourceX - 20, centerY, 0, sourceX - 20, centerY, 50);
            glowGradient.addColorStop(0, 'rgba(251, 146, 60, 0.3)');
            glowGradient.addColorStop(1, 'transparent');
            ctx.fillStyle = glowGradient;
            ctx.beginPath();
            ctx.arc(sourceX - 20, centerY, 50, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(sourceX, centerY - 8, 15, 16);
            
            ctx.fillStyle = '#94a3b8';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Ag Source', sourceX - 20, centerY + 60);
        }
        
        function drawMagnet() {
            const magnetWidth = magnetEndX - magnetStartX;
            const poleHeight = height * 0.15;
            
            ctx.fillStyle = '#dc2626';
            ctx.beginPath();
            ctx.moveTo(magnetStartX, magnetTopY - poleHeight);
            ctx.lineTo(magnetEndX, magnetTopY - poleHeight);
            ctx.lineTo(magnetEndX, magnetTopY);
            ctx.lineTo((magnetStartX + magnetEndX) / 2, magnetTopY + 30);
            ctx.lineTo(magnetStartX, magnetTopY);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = '#2563eb';
            ctx.beginPath();
            ctx.moveTo(magnetStartX, magnetBottomY + poleHeight);
            ctx.lineTo(magnetEndX, magnetBottomY + poleHeight);
            ctx.lineTo(magnetEndX, magnetBottomY);
            ctx.lineTo(magnetStartX, magnetBottomY);
            ctx.closePath();
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('N', (magnetStartX + magnetEndX) / 2, magnetTopY - poleHeight / 2);
            ctx.fillText('S', (magnetStartX + magnetEndX) / 2, magnetBottomY + poleHeight / 2 + 6);
            
            drawFieldLines();
        }
        
        function drawFieldLines() {
            const numLines = 8;
            const startY = magnetTopY + 20;
            const endY = magnetBottomY - 10;
            
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i < numLines; i++) {
                const x = magnetStartX + (magnetEndX - magnetStartX) * (i + 0.5) / numLines;
                
                ctx.beginPath();
                ctx.moveTo(x, startY);
                
                const midX = x + (x - (magnetStartX + magnetEndX) / 2) * 0.3 * fieldStrength / 5;
                ctx.quadraticCurveTo(midX, centerY, x, endY);
                ctx.stroke();
                
                const arrowY = centerY;
                const arrowX = midX;
                ctx.beginPath();
                ctx.moveTo(arrowX - 4, arrowY - 6);
                ctx.lineTo(arrowX, arrowY);
                ctx.lineTo(arrowX + 4, arrowY - 6);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#94a3b8';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`B = ${fieldStrength} T`, (magnetStartX + magnetEndX) / 2, magnetBottomY + height * 0.2 + 25);
            ctx.fillText('‚àÇB/‚àÇz ‚â† 0', (magnetStartX + magnetEndX) / 2, magnetBottomY + height * 0.2 + 40);
        }
        
        function drawDetector() {
            const detectorWidth = 15;
            const screenHeight = detectorHeight;
            
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.roundRect(detectorX - detectorWidth / 2, centerY - screenHeight / 2, detectorWidth, screenHeight, 4);
            ctx.fill();
            
            ctx.strokeStyle = '#475569';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            const spotOffset = fieldStrength * 6;
            
            if (classicalMode) {
                // Classical: show continuous spread expectation
                const gradientHeight = spotOffset * 2.5;
                ctx.fillStyle = 'rgba(245, 158, 11, 0.15)';
                ctx.beginPath();
                ctx.ellipse(detectorX, centerY, 8, gradientHeight, 0, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Quantum: show two discrete spots
                ctx.fillStyle = 'rgba(244, 114, 182, 0.2)';
                ctx.beginPath();
                ctx.ellipse(detectorX, centerY - spotOffset, 8, 20, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'rgba(96, 165, 250, 0.2)';
                ctx.beginPath();
                ctx.ellipse(detectorX, centerY + spotOffset, 8, 20, 0, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.fillStyle = '#94a3b8';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Detector', detectorX, centerY + screenHeight / 2 + 18);
        }
        
        function drawDetectorWindow() {
            const windowTop = centerY - detectorWindowHeight / 2;
            const windowLeft = detectorWindowX;
            
            ctx.fillStyle = 'rgba(30, 41, 59, 0.9)';
            ctx.beginPath();
            ctx.roundRect(windowLeft, windowTop, detectorWindowWidth, detectorWindowHeight, 8);
            ctx.fill();
            
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(windowLeft + 10, centerY);
            ctx.lineTo(windowLeft + detectorWindowWidth - 10, centerY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            const windowCenterX = windowLeft + detectorWindowWidth / 2;
            for (const point of detectionPoints) {
                let color;
                if (point.isClassical) {
                    color = 'rgba(245, 158, 11, 0.6)';
                } else {
                    color = point.spin > 0 ? 'rgba(244, 114, 182, 0.6)' : 'rgba(96, 165, 250, 0.6)';
                }
                ctx.beginPath();
                ctx.arc(windowCenterX + point.x, windowTop + point.y, 3, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
            }
            
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'left';
            
            if (classicalMode) {
                ctx.fillText('Max ‚Üë', windowLeft + 10, windowTop + 20);
                ctx.fillText('Max ‚Üì', windowLeft + 10, windowTop + detectorWindowHeight - 10);
            } else {
                ctx.fillText('Spin ‚Üë', windowLeft + 10, windowTop + 20);
                ctx.fillText('Spin ‚Üì', windowLeft + 10, windowTop + detectorWindowHeight - 10);
            }
            
            ctx.fillStyle = '#f1f5f9';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            const modeLabel = classicalMode ? 'üìä Classical Result' : 'üéØ Quantum Result';
            ctx.fillText(modeLabel, windowLeft + detectorWindowWidth / 2, windowTop - 10);
            
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(detectorX + 10, centerY);
            ctx.lineTo(windowLeft, centerY);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        function drawBeamPath() {
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;
            
            ctx.strokeStyle = 'rgba(163, 230, 53, 0.4)';
            ctx.beginPath();
            ctx.moveTo(sourceX + 15, centerY);
            ctx.lineTo(magnetStartX, centerY);
            ctx.stroke();
            
            const splitAmount = fieldStrength * 6;
            const magnetCenterX = (magnetStartX + magnetEndX) / 2;
            
            if (classicalMode) {
                // Classical: show spread of paths
                for (let i = -5; i <= 5; i++) {
                    const fraction = i / 5;
                    const deflection = splitAmount * fraction;
                    const alpha = 0.15 + 0.1 * (1 - Math.abs(fraction));
                    ctx.strokeStyle = `rgba(245, 158, 11, ${alpha})`;
                    ctx.beginPath();
                    ctx.moveTo(magnetCenterX, centerY);
                    ctx.quadraticCurveTo(magnetEndX, centerY + deflection * 0.5, detectorX, centerY + deflection);
                    ctx.stroke();
                }
            } else {
                // Quantum: show two discrete paths
                ctx.strokeStyle = 'rgba(244, 114, 182, 0.3)';
                ctx.beginPath();
                ctx.moveTo(magnetCenterX, centerY);
                ctx.quadraticCurveTo(magnetEndX, centerY - splitAmount * 0.5, detectorX, centerY - splitAmount);
                ctx.stroke();
                
                ctx.strokeStyle = 'rgba(96, 165, 250, 0.3)';
                ctx.beginPath();
                ctx.moveTo(magnetCenterX, centerY);
                ctx.quadraticCurveTo(magnetEndX, centerY + splitAmount * 0.5, detectorX, centerY + splitAmount);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
        }
        
        function emitAtom() {
            atoms.push(new Atom());
        }
        
        function updateStats() {
            document.getElementById('totalAtoms').textContent = totalCount;
            document.getElementById('spinUp').textContent = spinUpCount;
            document.getElementById('spinDown').textContent = spinDownCount;
        }
        
        function updateModeUI() {
            const indicator = document.getElementById('modeIndicator');
            const toggleBtn = document.getElementById('classicalToggle');
            
            if (classicalMode) {
                indicator.className = 'mode-indicator classical';
                indicator.textContent = 'üìä Classical Mode';
                toggleBtn.textContent = '‚öõÔ∏è Switch to Quantum Mode';
                toggleBtn.classList.add('active');
            } else {
                indicator.className = 'mode-indicator quantum';
                indicator.textContent = '‚öõÔ∏è Quantum Mode';
                toggleBtn.textContent = 'üìä Switch to Classical Mode';
                toggleBtn.classList.remove('active');
            }
        }
        
        function animate(currentTime) {
            const emitInterval = 1000 / emissionRate;
            if (currentTime - lastEmitTime > emitInterval) {
                emitAtom();
                lastEmitTime = currentTime;
            }
            
            drawBackground();
            drawBeamPath();
            drawSource();
            drawMagnet();
            drawDetector();
            drawDetectorWindow();
            
            atoms = atoms.filter(atom => {
                const alive = atom.update();
                if (alive || !atom.detected) {
                    atom.draw();
                }
                return alive;
            });
            
            updateStats();
            
            requestAnimationFrame(animate);
        }
        
        function reset() {
            atoms = [];
            spinUpCount = 0;
            spinDownCount = 0;
            totalCount = 0;
            detectionPoints = [];
        }
        
        // Event listeners
        document.getElementById('fieldStrength').addEventListener('input', (e) => {
            fieldStrength = parseInt(e.target.value);
            document.getElementById('fieldValue').textContent = fieldStrength;
        });
        
        document.getElementById('emissionRate').addEventListener('input', (e) => {
            emissionRate = parseInt(e.target.value);
            document.getElementById('emissionValue').textContent = emissionRate;
        });
        
        document.getElementById('reset').addEventListener('click', reset);
        
        // NEW: Classical mode toggle
        document.getElementById('classicalToggle').addEventListener('click', () => {
            classicalMode = !classicalMode;
            updateModeUI();
            reset();  // Reset when switching modes for clear comparison
        });
        
        window.addEventListener('resize', resize);
        
        // Initialize
        resize();
        updateModeUI();
        requestAnimationFrame(animate);
    </script>
</body>
</html>